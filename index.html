<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Manufacturing Defect Detector - Deep Learning</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

<style>
body{
font-family:Segoe UI;
background:linear-gradient(135deg,#667eea,#764ba2);
min-height:100vh;padding:30px;color:white;text-align:center}
.card{background:white;color:black;padding:30px;border-radius:20px;margin:20px auto;max-width:900px}
button{padding:15px 40px;font-size:18px;background:#10b981;color:white;border:none;border-radius:50px;cursor:pointer}
.metric{font-size:32px;font-weight:bold}
.pass{background:#d1fae5;border:4px solid #10b981}
.fail{background:#fee2e2;border:4px solid #ef4444}
</style>
</head>

<body>

<h1>ü§ñ Deep Learning Manufacturing Defect Detector</h1>
<p>Powered by TensorFlow.js CNN</p>

<div class="card">
<input type="file" id="fileInput" accept="image/*">
<br><br>
<button onclick="analyze()">Run AI Inspection</button>
</div>

<div id="preview"></div>
<div id="results"></div>

<script>
let model;
let referenceVector=null;

async function loadModel(){
    model = await mobilenet.load();
    console.log("Model Loaded");
}
loadModel();

/* ---------- FEATURE EXTRACTION ---------- */
async function extractFeatures(img){
    const tensor = tf.browser.fromPixels(img)
        .resizeNearestNeighbor([224,224])
        .toFloat()
        .expandDims();

    const embeddings = model.infer(tensor,true);
    return embeddings.dataSync();
}

/* ---------- DISTANCE MEASURE ---------- */
function cosineDistance(a,b){
    let dot=0,magA=0,magB=0;
    for(let i=0;i<a.length;i++){
        dot+=a[i]*b[i];
        magA+=a[i]*a[i];
        magB+=b[i]*b[i];
    }
    return 1-(dot/(Math.sqrt(magA)*Math.sqrt(magB)));
}

/* ---------- MAIN ANALYSIS ---------- */
async function analyze(){
    const file=fileInput.files[0];
    if(!file) return alert("Upload image first");

    const img=new Image();
    img.src=URL.createObjectURL(file);
    preview.innerHTML="<h2>Processing with Deep Learning...</h2>";

    img.onload=async ()=>{
        preview.innerHTML=`<img src="${img.src}" width="300">`;

        const features = await extractFeatures(img);

        // First image becomes reference "GOOD PRODUCT"
        if(!referenceVector){
            referenceVector = features;
            results.innerHTML=`
                <div class="card pass">
                <h2>‚úÖ Reference Product Saved</h2>
                <p>Upload defective product to test detection</p>
                </div>`;
            return;
        }

        const anomalyScore = cosineDistance(referenceVector,features);

        const defectProbability = Math.min(anomalyScore*3,1);
        const confidence = (defectProbability*100).toFixed(1);

        const defective = defectProbability > 0.35;

        results.innerHTML=`
        <div class="card ${defective?'fail':'pass'}">
        <h2>${defective?'‚ùå DEFECT DETECTED':'‚úÖ QUALITY PASSED'}</h2>
        <h3>Defect Probability: ${confidence}%</h3>
        <p>Anomaly Score: ${anomalyScore.toFixed(3)}</p>
        </div>`;
    }
}
</script>
</body>
</html>
